<!-- result.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Parsed Text Result</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Parsed Text</h1>
        <div class="container" style="position: fixed">
            <button class="btn btn-danger delete-selected-btn">Delete Selected</button>
            <button class="btn btn-danger delete-all-btn" style="display: none;">Delete All</button>
            <button class="btn btn-primary delete-cancelled-btn" style="display: none;">Cancel</button>

            <button class="btn btn-info merged-selected-btn">Merge Selected</button>
            <button class="btn btn-info translate-again-btn" style="display: none;">Translate Again</button>
            <button class="btn btn-primary merged-cancelled-btn" style="display: none;">Cancel</button>
        </div>

        <div class="container result-list">
            {% for translated_text, origin_text in text.items()|zip(origin.items())%}
            <div class="container m-2 border border-dark rounded d-flex result" data-index="{{origin_text[0]}}">
                <div class="container">
                    <p class="fw-bold">Origin Text :</p>
                    <textarea rows="5" class="origin_text" data-index="{{origin_text[0]}}" style="width: 100%;">{{origin_text[1]}} </textarea>
                    <p class="fw-bold">Translated Text : </p>
                    <p class="translated_text" data-index="{{origin_text[0]}}">{{translated_text[1]}}</p>                     
                </div>
                <div>
                    <button class="btn btn-primary delete-btn" data-index="{{ origin_text[0] }}">delete</button>
                </div>
                <div>
                    <input type="checkbox" class="item-checkbox" data-index="{{origin_text[0]}}" style="display: none;">
                </div>
                <div>
                    <input type="checkbox" class="merged-checkbox" data-index="{{origin_text[0]}}" style="display: none;">
                </div>
            </div>
            {% endfor %}
        </div>             
    </div>

    <script>
        $(document).ready(function() {

            // Handle click event on delete buttons
            $('.delete-btn').click(function() {
                var index = [$(this).data('index')];
                console.log("in delete-btn selector",index);
                // show a comfirmation dialog box
                if(!comfirmed()){
                    return;
                }

                // Send Ajax request to delete route
                deleteItems(index);
            });
            
            $('.delete-selected-btn').click(function() {
                $('.item-checkbox').show();
                $('.delete-all-btn').show();
                $('.delete-cancelled-btn').show();
                $(this).hide();
            });

            $('.delete-cancelled-btn').click(function () {
                $(this).hide();
                $('.delete-all-btn').hide();
                $('.delete-selected-btn').show();
                $('.item-checkbox').hide();
            })

            $('.delete-all-btn').click(async function() {
                var allIndices = [];
                $('.item-checkbox').each(async function () {
                    if($(this).is(':checked')){
                        var index = $(this).data('index');
                        allIndices.push(index);
                    }
                });
                console.log(allIndices);
                if(allIndices.length === 0){
                    alert('No items to delete');
                    return;
                }
                // show a comfirmation dialog box  
                if(!comfirmed()){
                    return;
                }
                
                // Send Ajax request to delete route
                deleteItems(allIndices);
            })
            // Handle merge event to translate the paragraph again
            $('.translate-again-btn').click(function () {
                var merged_text = "";
                var merged_index = []
                $('.merged-checkbox').each(function () {
                    if($(this).is(':checked')){
                        var index = $(this).data('index');
                        merged_index.push(index);
                        merged_text += $('.origin_text[data-index="'+index+'"]').text()
                    }
                })
                console.log(merged_text);

                if(merged_index.length === 0){
                    alert('No items to merge')
                    return;
                }

                if(!confirm()){
                    return;
                }

                translate(merged_text, merged_index)
            })
            
            $('.merged-cancelled-btn').click(function() {
                $('.translate-again-btn').hide();
                $('.merged-selected-btn').show();
                $('.merged-checkbox').hide();
                $(this).hide();
            })
            $('.merged-selected-btn').click(function() {
                $(this).hide();
                $('.translate-again-btn').show();
                $('.merged-checkbox').show();
                $('.merged-cancelled-btn').show();
            })
            function deleteItems (allIndices) {
                $.ajax({
                    url: '/delete',
                    type: 'POST',
                    data: {indices : allIndices},
                    success: function(response) {
                        if (response.success) {
                            // If deletion was successful, remove all items from the list on the client side
                            allIndices.forEach(index => {
                                $('.result[data-index="'+index+'"]').remove();
                            });
                        } else {
                            // Handle error if the items cannot be deleted
                            alert('Failed to delete all items.');
                        }
                    },
                    error: function() {
                        // Handle error if the Ajax request fails
                        alert('Failed to delete all items.');
                    }
                });  
            }
            function comfirmed (){
                // Show a confirmation dialog box
                var confirmed = confirm('Are you sure you want to delete all items?');
                if (!confirmed) {
                    return false; // If the user clicks "Cancel", do nothing
                }
                return true;
            }
            
            function translate (text, text_index){
                text_index.sort();
                console.log("Lets start to merge the text in ",text_index)
                $.ajax({
                    url: '/translate',
                    type: 'POST',
                    data: {text: text,
                           indices: text_index},
                    success: function(response) {
                        if(response.success) {
                            text_index.forEach(index => {
                                if (index !== text_index[0]){
                                    $('.result[data-index="'+index+'"]').remove();
                                }
                                else{
                                    $('.origin_text[data-index="'+index+'"]').text(text);
                                    $('.translated_text[data-index="'+index+'"]').text(response.text);
                                }
                            })
                        }
                        else{
                            alert('Failed to translate the new text');
                        }
                    },
                    error: function(){
                        alert('Failed to translate the new text');
                    }
                });
            }
        });
    </script>
    </script>
</body>
</html>
